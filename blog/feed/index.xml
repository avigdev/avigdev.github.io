<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
     xmlns:content="http://purl.org/rss/1.0/modules/content/"
     xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
     xmlns:atom="http://www.w3.org/2005/Atom"
     xmlns:dc="http://purl.org/dc/elements/1.1/"
     xmlns:wfw="http://wellformedweb.org/CommentAPI/"
     >
  <channel>
    <title>Avi Gozolchiani</title>
    <link>http://physionet.ph.biu.ac.il/~gozolaa/blog</link>
    <description>Environmental Physics at Ben Gurion University</description>
    <pubDate>Wed, 07 Jan 2015 19:08:33 GMT</pubDate>
    <generator>Blogofile</generator>
    <sy:updatePeriod>hourly</sy:updatePeriod>
    <sy:updateFrequency>1</sy:updateFrequency>
    <item>
      <title>create a document from your figures</title>
      <link>http://physionet.ph.biu.ac.il/~gozolaa/blog/20150107/2015-1-7-create-a-document-from-your-figures-html</link>
      <pubDate>Wed, 07 Jan 2015 20:42:00 IST</pubDate>
      <category><![CDATA[latex]]></category>
      <category><![CDATA[workflow]]></category>
      <guid isPermaLink="false">WhooOtN0-H1tBuXIqyKkCxU_JmI=</guid>
      <description>create a document from your figures</description>
      <content:encoded><![CDATA[



<p>
A part of the scientific workflow is creating images and categorizing them into directories. In our little parties, we scientist show these images to each other and brag about our ability to create more. It is therefore very useful to have bundles of these in pdf or html files (depending on the kind of party).
</p>

<p>
Here's how to create a pdf (using LaTeX) :
</p>

<div class="org-src-container">

<pre class="src src-perl"><span class="linenr">1: </span><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/perl -nw </span>
<span class="linenr">2: </span><span style="color: #b22222;">## </span><span style="color: #b22222;">syntax : ls fig_patterns | latexfigs.pl &gt; latexfile</span>
<span class="linenr">3: </span>chomp();
<span class="linenr">4: </span>print <span style="color: #8b2252;">"\\begin\{figure\}\n\\centering\n\\includegraphics\[scale=1.2,angle=0\]\{$_\}\n"</span>;
<span class="linenr">5: </span>s<span style="color: #8b2252;">/_/\\_/</span>g;
<span class="linenr">6: </span>print <span style="color: #8b2252;">"\\caption\{$_\}\n\\end\{figure\}\n\\clearpage\n"</span>;
</pre>
</div>

<p>
and Here's how to create a html : 
</p>

<div class="org-src-container">

<pre class="src src-perl"><span class="linenr">1: </span><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/perl -nw </span>
<span class="linenr">2: </span><span style="color: #b22222;">## </span><span style="color: #b22222;">syntax : ls fig_patterns | htmlfigs.pl &gt; htmlfile</span>
<span class="linenr">3: </span>chomp();
<span class="linenr">4: </span>print <span style="color: #8b2252;">"&lt;IMG src=\"$_\" width=650&gt;&lt;BR&gt;\n"</span>;
<span class="linenr">5: </span>print <span style="color: #8b2252;">"$_&lt;BR&gt;&lt;BR&gt;\n"</span>;
</pre>
</div>

<p>
After some time, you may want to make a section in your book/paper from each directory.
</p>

<p>
here's the LaTeX version : 
</p>
<div class="org-src-container">

<pre class="src src-perl"><span class="linenr">1: </span><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/perl -w </span>
<span class="linenr">2: </span><span style="color: #b22222;">## </span><span style="color: #b22222;">syntax : anchor_latex.pl "tag" "text" &gt;&gt; file.latex</span>
<span class="linenr">3: </span>$<span style="color: #a0522d;">tag</span>=shift or <span style="color: #932092;">die</span> <span style="color: #8b2252;">"syntax error: anchor_latex.pl \"tag\" \"text\"&gt;&gt;file.latex\n"</span>;
<span class="linenr">4: </span>$<span style="color: #a0522d;">text</span>=shift or <span style="color: #932092;">die</span> <span style="color: #8b2252;">"syntax error: anchor_latex.pl \"tag\" \"text\"&gt;&gt;file.latex\n"</span>;
<span class="linenr">5: </span>print <span style="color: #8b2252;">"\\section{$text}\\label{sec:$tag}\n"</span>;
</pre>
</div>

<p>
and here's the html :
</p>
<div class="org-src-container">

<pre class="src src-perl"><span class="linenr">1: </span><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/perl -w </span>
<span class="linenr">2: </span><span style="color: #b22222;">## </span><span style="color: #b22222;">syntax : anchor_html.pl "tag" "text" &gt;&gt; file.html</span>
<span class="linenr">3: </span>$<span style="color: #a0522d;">tag</span>=shift or <span style="color: #932092;">die</span> <span style="color: #8b2252;">"syntax error: anchor_html.pl \"tag\" \"text\"&gt;&gt;file.html\n"</span>;
<span class="linenr">4: </span>$<span style="color: #a0522d;">text</span>=shift or <span style="color: #932092;">die</span> <span style="color: #8b2252;">"syntax error: anchor_html.pl \"tag\" \"text\"&gt;&gt;file.html\n"</span>;
<span class="linenr">5: </span>print <span style="color: #8b2252;">"&lt;a id=\"$tag\"&gt;&lt;h2&gt;$text&lt;/h2&gt;&lt;/a&gt;\n"</span>;
</pre>
</div>

<p>
you can include a template for a latexfile in your home directory : 
</p>
<div class="org-src-container">

<pre class="src src-latex"><span class="linenr"> 1: </span><span style="color: #932092;">\documentclass</span>[A4paper]{<span style="color: #483d8b;">article</span>}
<span class="linenr"> 2: </span><span style="color: #932092;">\usepackage</span>{<span style="color: #483d8b;">graphicx</span>}
<span class="linenr"> 3: </span><span style="color: #932092;">\usepackage</span>{<span style="color: #483d8b;">cite</span>}
<span class="linenr"> 4: </span><span style="color: #932092;">\usepackage</span>{<span style="color: #483d8b;">placeins</span>} <span style="color: #b22222;">% floatbarrier definition</span>
<span class="linenr"> 5: </span><span style="color: #932092;">\usepackage</span>[caption=false]{<span style="color: #483d8b;">subfig</span>}
<span class="linenr"> 6: </span><span style="color: #932092;">\usepackage</span>{<span style="color: #483d8b;">fullpage</span>}
<span class="linenr"> 7: </span><span style="color: #932092;">\newcommand</span>{<span style="color: #0000ff;">\unit</span>}[1]{<span style="color: #932092;">\ensuremath</span>{<span style="color: #932092;">\,</span> <span style="color: #932092;">\mathrm</span>{#1}}}
<span class="linenr"> 8: </span><span style="color: #932092;">\begin</span>{<span style="color: #0000ff;">document</span>}
<span class="linenr"> 9: </span>TEXT
<span class="linenr">10: </span><span style="color: #932092;">\end</span>{<span style="color: #0000ff;">document</span>}
</pre>
</div>

<p>
and substitute your created latex code into the <b>TEXT</b> part, using perl again : 
</p>
<div class="org-src-container">

<pre class="src src-perl"><span class="linenr"> 1: </span><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/perl -w </span>
<span class="linenr"> 2: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">syntax : merge_latex_tmpl.pl tmpfile &gt; merged_file.tex</span>
<span class="linenr"> 3: </span>$<span style="color: #a0522d;">tmplfilename</span>=$<span style="color: #a0522d;">ENV</span>{<span style="color: #8b2252;">'LATEXTMPL'</span>};
<span class="linenr"> 4: </span>$<span style="color: #a0522d;">filename</span>=shift // <span style="color: #932092;">die</span> <span style="color: #8b2252;">"syntax error"</span>;
<span class="linenr"> 5: </span>open TMPL,<span style="color: #8b2252;">"&lt;$tmplfilename"</span> // <span style="color: #932092;">die</span> <span style="color: #8b2252;">"could not find the template file"</span>;
<span class="linenr"> 6: </span>open FILE,<span style="color: #8b2252;">"&lt;$filename"</span> // <span style="color: #932092;">die</span> <span style="color: #8b2252;">"could not find the file $filename"</span>;
<span class="linenr"> 7: </span>$<span style="color: #a0522d;">uniq_content</span> = join(<span style="color: #8b2252;">""</span>, &lt;<span style="color: #008b8b;">FILE</span>&gt;); 
<span class="linenr"> 8: </span><span style="color: #932092;">while</span>(&lt;<span style="color: #008b8b;">TMPL</span>&gt;){
<span class="linenr"> 9: </span>    <span style="color: #932092;">if</span>(<span style="color: #8b2252;">/TEXT/</span>){
<span class="linenr">10: </span>        print $<span style="color: #a0522d;">uniq_content</span>;
<span class="linenr">11: </span>    }<span style="color: #932092;">else</span>{
<span class="linenr">12: </span>        print;
<span class="linenr">13: </span>    }
<span class="linenr">14: </span>}
</pre>
</div>

<p>
where <i>LATEXTMPL</i> is an environment variable, telling your script the location of your template. I like templates, and I clutter quite a bit as hidden files in my home directory. Do you do it differently ? 
</p>
<p>Copyright (C) 2015 by Avi Gozolchiani. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2015/1/7/create-a-document-from-your-figures.org">org-mode source</a><p>]]></content:encoded>
    </item>
    <item>
      <title>ncdump -h for matlab</title>
      <link>http://physionet.ph.biu.ac.il/~gozolaa/blog/20141230/2014-12-30-ncdump-h-for-matlab-html</link>
      <pubDate>Tue, 30 Dec 2014 13:16:00 IST</pubDate>
      <category><![CDATA[matlab]]></category>
      <category><![CDATA[octave]]></category>
      <guid isPermaLink="false">HvingZzj5fUehC5EIezA4xPA6cc=</guid>
      <description>ncdump -h for matlab</description>
      <content:encoded><![CDATA[



<p>
I launch "ncdump -h" many times during my workflow. It gives you all the meta-data you need for netcdf files, without the hassle of openning a more serious program like <a href="http://ferret.pmel.noaa.gov/Ferret/">ferret</a> . I figured out that I need the same for mat files. You will need <a href="https://www.gnu.org/software/octave/">octave</a> to make it work&#x2026;
</p>

<div class="org-src-container">

<pre class="src src-matlab"><span class="linenr">1: </span>#<span style="color: #228b22;">!/</span>usr<span style="color: #228b22;">/</span>local<span style="color: #228b22;">/</span>bin<span style="color: #228b22;">/</span>octave <span style="color: #228b22;">-</span>q
<span class="linenr">2: </span>whos(<span style="color: #8b2252;">'-file'</span>,argv(){1})
</pre>
</div>
<p>Copyright (C) 2015 by Avi Gozolchiani. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/12/30/ncdump--h-for-matlab.org">org-mode source</a><p>]]></content:encoded>
    </item>
    <item>
      <title>simplify slurm and qsub</title>
      <link>http://physionet.ph.biu.ac.il/~gozolaa/blog/20141228/2014-12-28-simplify-slurm-and-qsub-html</link>
      <pubDate>Sun, 28 Dec 2014 18:48:02 IST</pubDate>
      <category><![CDATA[orgmode]]></category>
      <category><![CDATA[qsub]]></category>
      <category><![CDATA[slurm]]></category>
      <guid isPermaLink="false">RLSyZy5k9NZsmEAroVU2MdH9Yg8=</guid>
      <description>simplify slurm and qsub</description>
      <content:encoded><![CDATA[



<p>
<a href="http://slurm.schedmd.com">slurm</a> and qsub (link anyone?) are beautiful cluster schedulers. If you work on a cluster, you probably use one. I use both, as well as some old computers which don't have schedulers. I manage my runs from an <a href="http://orgmode.org">orgmode</a> "notebook", with a table that tells my scripts which resource uses which scheduler. 
</p>

<p>
The usual way to use slurm and qsub is by submitting a little shell script which tells all the nodes how to divide their tasks, what are the important environment variables, which command are we running, etc. If you work on clusters you probably have a zillion copies of these little scripts.  
</p>

<p>
<i>FIRST</i>, most of the information is identical, so why not create a template at the home directory ? Instead of the absolute path of the current run, insert %s, instead of the number of mpi threads insert %d &#x2026; you get the idea. I call my template .slurm_cmds . 
</p>

<p>
Now, we need to automatically create templates by replacing all those %x by our real information, and submit to the queue:
</p>

<div class="org-src-container">

<pre class="src src-perl" id="slurm_run"><span class="linenr"> 1: </span><span style="color: #b22222;">#</span><span style="color: #b22222;">!/usr/bin/perl -w</span>
<span class="linenr"> 2: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">purpose : insert a job to the slurm queue</span>
<span class="linenr"> 3: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">syntax : slurm_run.pl number_of_processes cmd</span>
<span class="linenr"> 4: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">number_of_processes= the number of cores that are expected to be used by</span>
<span class="linenr"> 5: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">the job. this is not verified - so consistency with the compilation under</span>
<span class="linenr"> 6: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">MPI is just assumed and is the responsibility of the user. </span>
<span class="linenr"> 7: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">cmd = the executable (usually binary) you wish to include in the queue </span>
<span class="linenr"> 8: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">the file .slurm_cmds is expected to be found on the $HOME directory.</span>
<span class="linenr"> 9: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">this file is a template batch file with all the needed exports and a srun</span>
<span class="linenr">10: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">call. slurm_run.pl just reads the template, replaces the necessary info to</span>
<span class="linenr">11: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">the right places, and sends the new formed batch file to the queue.</span>
<span class="linenr">12: </span><span style="color: #b22222;">#</span>
<span class="linenr">13: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">depends on : (1) the perl Env and Cwd libraries ,</span>
<span class="linenr">14: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">(2) the $HOME/.slurm_cmds template</span>
<span class="linenr">15: </span><span style="color: #b22222;">#</span>
<span class="linenr">16: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">Copyright 2012 Avi Gozolchiani (http://tiny.cc/avigoz)</span>
<span class="linenr">17: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">This program is free software: you can redistribute it and/or modify</span>
<span class="linenr">18: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">it under the terms of the GNU General Public License as published by</span>
<span class="linenr">19: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenr">20: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">(at your option) any later version.</span>
<span class="linenr">21: </span><span style="color: #b22222;">#</span>
<span class="linenr">22: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">This program is distributed in the hope that it will be useful,</span>
<span class="linenr">23: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenr">24: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenr">25: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">GNU General Public License for more details.</span>
<span class="linenr">26: </span><span style="color: #b22222;">#</span>
<span class="linenr">27: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">You should have received a copy of the GNU General Public License</span>
<span class="linenr">28: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">along with this program.  If not, see &lt;<a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>&gt;.</span>
<span class="linenr">29: </span>
<span class="linenr">30: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">$Log$</span>
<span class="linenr">31: </span><span style="color: #932092;">use</span> <span style="color: #008b8b;">Env</span>;
<span class="linenr">32: </span><span style="color: #932092;">use</span> <span style="color: #008b8b;">Cwd</span>;
<span class="linenr">33: </span>$<span style="color: #a0522d;">currWorkDir</span> = &amp;<span style="color: #0000ff;">Cwd::cwd</span>();
<span class="linenr">34: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">parse cmd line</span>
<span class="linenr">35: </span>$<span style="color: #a0522d;">n_proc</span>=shift //<span style="color: #932092;">die</span> <span style="color: #8b2252;">"syntax error : slurm_run number_of_processes cmd\n"</span>;
<span class="linenr">36: </span>$<span style="color: #a0522d;">cmd</span>=shift //<span style="color: #932092;">die</span> <span style="color: #8b2252;">"syntax error : slurm_run number_of_processes cmd\n"</span>;
<span class="linenr">37: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">define file names (both source and target)</span>
<span class="linenr">38: </span>$<span style="color: #a0522d;">slurm_template</span>=<span style="color: #8b2252;">"$HOME/.slurm_cmds"</span>;
<span class="linenr">39: </span>$<span style="color: #a0522d;">batch_name</span>=<span style="color: #8b2252;">"run-mit.batch_$1"</span>;
<span class="linenr">40: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">open the files</span>
<span class="linenr">41: </span>open SLURMTEMP, $<span style="color: #a0522d;">slurm_template</span> or <span style="color: #932092;">die</span> <span style="color: #8b2252;">"couldn't find the template file\n"</span>;
<span class="linenr">42: </span>open BATCH,<span style="color: #8b2252;">"&gt;$batch_name"</span> or <span style="color: #932092;">die</span> <span style="color: #8b2252;">"couldn't write a temporary batch file\n"</span>;
<span class="linenr">43: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">copy each line from the source template to the target, with</span>
<span class="linenr">44: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">the necessary changes</span>
<span class="linenr">45: </span><span style="color: #932092;">while</span>(&lt;<span style="color: #008b8b;">SLURMTEMP</span>&gt;){
<span class="linenr">46: </span>    <span style="color: #932092;">last</span> <span style="color: #932092;">if</span> length($<span style="color: #a0522d;">_</span>)==0;
<span class="linenr">47: </span>    <span style="color: #932092;">if</span>(<span style="color: #8b2252;">/cd/</span>){
<span class="linenr">48: </span>        printf BATCH $<span style="color: #a0522d;">_</span>,$<span style="color: #a0522d;">currWorkDir</span>;
<span class="linenr">49: </span>    }<span style="color: #932092;">elsif</span>(<span style="color: #8b2252;">/srun/</span>){ <span style="color: #b22222;"># if(/cd/){</span>
<span class="linenr">50: </span>        printf BATCH $<span style="color: #a0522d;">_</span> , $<span style="color: #a0522d;">n_proc</span>, $<span style="color: #a0522d;">cmd</span>;
<span class="linenr">51: </span>    }<span style="color: #932092;">elsif</span>(<span style="color: #8b2252;">/SBATCH/</span>){ <span style="color: #b22222;"># if(/cd/){ ... }elsif(/srun/){</span>
<span class="linenr">52: </span>        printf BATCH $<span style="color: #a0522d;">_</span>, $<span style="color: #a0522d;">n_proc</span>;
<span class="linenr">53: </span>    }<span style="color: #932092;">else</span>{   <span style="color: #b22222;"># if(/cd/){... }elsif(/srun/){...}elsif(/SBATCH/){</span>
<span class="linenr">54: </span>        print BATCH $<span style="color: #a0522d;">_</span>;
<span class="linenr">55: </span>    }        <span style="color: #b22222;"># if(/cd/){... }elsif(/srun/){...}elsif(/SBATCH/){..}else{</span>
<span class="linenr">56: </span>}                               <span style="color: #b22222;"># while(&lt;SLURMTEMP&gt;){</span>
<span class="linenr">57: </span>close BATCH;
<span class="linenr">58: </span><span style="color: #b22222;"># </span><span style="color: #b22222;">send to queue</span>
<span class="linenr">59: </span>print <span style="color: #8b2252;">`sbatch -x n03 ./$batch_name`</span>;
</pre>
</div>

<p>
The last line submits my fresh batch file to the slurm queue. I can monitor it's processing via :
</p>
<div class="org-src-container">

<pre class="src src-sh"><span class="linenr">1: </span>squeue  -o <span style="color: #8b2252;">'%.7i %.9P %.50j %.8u %.2t %.10M %.5D %.6C %R'</span>
</pre>
</div>


<p>
the "%.50j" is important, since we want to know the full job names.
</p>

<p>
The "-x n03" part in slurm_run.pl was added since our system admin asked me to not use node 03. Is there a better way to consistently do it?
</p>
<p>Copyright (C) 2015 by Avi Gozolchiani. See the <a href="/copying.html">License</a> for information about copying.<p><p><a href="/org/2014/12/28/simplify-slurm-and-qsub.org">org-mode source</a><p>]]></content:encoded>
    </item>
  </channel>
</rss>
